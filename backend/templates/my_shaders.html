<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>My Shaders</title>
<style>
body { font-family: system-ui, sans-serif; margin:40px; }
header a { margin-right:1rem; }
.grid { display:grid; gap:1rem; grid-template-columns: repeat(auto-fill, minmax(260px,1fr)); }
.card { border:1px solid #ccc; padding:0.75rem; border-radius:6px; background:#f5faff; }
.tags span { font-size:.7rem; background:#dde; padding:2px 6px; margin:2px; display:inline-block; border-radius:3px; }
form#create { margin:1.5rem 0; padding:1rem; border:1px solid #ccc; border-radius:6px; }
textarea { width:100%; height:140px; font-family:monospace; font-size:12px; }
</style>
</head>
<body>
<header>
  <a href="/shaders">Browse</a>
  <a href="/my">My Shaders</a>
  <a href="/login">Login</a>
</header>
<h1>My Shaders</h1>
<p>User: {{.User.Username}}</p>
<form id="create">
  <h2>Create Shader</h2>
  <label>Title <input name="title" required /></label><br/>
  <label>Tags (comma separated) <input name="tags" /></label><br/>
  <label>Code</label>
  <textarea name="code">// WGSL shader code here
</textarea>
  <button type="submit">Save</button> <span id="saveStatus"></span>
</form>
<div class="grid" id="list">
{{range .Shaders}}
  <div class="card">
    <h3 contenteditable="true" data-field="title" data-id="{{.ID}}">{{.Title}}</h3>
    <div class="tags" contenteditable="true" data-field="tags" data-id="{{.ID}}">{{range $i,$t := .Tags}}{{if $i}}, {{end}}{{$t}}{{end}}</div>
    <pre contenteditable="true" data-field="code" data-id="{{.ID}}" style="white-space:pre-wrap;font-size:11px;max-height:160px;overflow:auto;">{{.Code}}</pre>
    <button data-action="update" data-id="{{.ID}}">Update</button>
  </div>
{{else}}
  <p>No shaders yet.</p>
{{end}}
</div>
<script>
async function api(path, opts={}){
  opts.headers = opts.headers || {}; opts.headers['Content-Type']='application/json';
  // token is in auth cookie for pages; for api calls JS can rely on cookie
  return fetch('/api'+path, opts);
}

const form = document.getElementById('create');
form.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const fd = new FormData(form);
  const body = {title: fd.get('title'), code: fd.get('code'), tags: (fd.get('tags')||'').split(',').map(s=>s.trim()).filter(Boolean)};
  const res = await api('/shaders', {method:'POST', body: JSON.stringify(body)});
  const status = document.getElementById('saveStatus');
  if(res.ok){ status.textContent='Saved'; status.style.color='green'; location.reload(); }
  else { const j = await res.json().catch(()=>({error:'error'})); status.textContent=j.error; status.style.color='red'; }
});

document.getElementById('list').addEventListener('click', async (e)=>{
  const btn = e.target.closest('button[data-action="update"]');
  if(!btn) return;
  const id = btn.dataset.id;
  const card = btn.parentElement;
  const title = card.querySelector('[data-field="title"]').innerText.trim();
  const code = card.querySelector('[data-field="code"]').innerText;
  const tagsRaw = card.querySelector('[data-field="tags"]').innerText.split(',').map(s=>s.trim()).filter(Boolean);
  const res = await api('/shaders/'+id, {method:'PUT', body: JSON.stringify({title, code, tags: tagsRaw})});
  if(res.ok){ btn.textContent='Updated'; setTimeout(()=>btn.textContent='Update',1500);} else { btn.textContent='Err'; }
});
</script>
</body>
</html>
