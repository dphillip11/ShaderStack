{{ define "Title" }}
        Shader Editor
    {{ end }}

    {{ define "Content" }}
    <div class="editor-page">
        <div class="editor-header">
            <div class="shader-info">
                <h1 class="shader-title">{{if .Shader.Name}}{{.Shader.Name}}{{else}}New Shader{{end}}</h1>
                {{if .Author}}<p class="shader-author">by {{.Author}}</p>{{end}}
            </div>
            <div class="editor-actions">
                {{if .Shader.ID}}
                <button id="save-shader" class="btn-primary">
                    <i class="fas fa-save"></i> Save
                </button>
                {{else}}
                <button id="create-shader" class="btn-primary">
                    <i class="fas fa-plus"></i> Create Shader
                </button>
                {{end}}
                <button id="run-shader" class="btn-secondary">
                    <i class="fas fa-play"></i> Run
                </button>
            </div>
        </div>

        <div class="editor-layout">
            <!-- Sidebar for properties -->
            <div class="editor-sidebar">
                {{template "shader_properties.html" .}}
            </div>

            <!-- Main editor area with resizable panels -->
            <div class="editor-main-container">
                <div class="resizable-layout" data-controller="split-window">
                    <!-- Code Editor Panel -->
                    <div class="code-panel split-window-pane left" data-pane="left">
                        <div class="panel-header">
                            <h3>Code Editor</h3>
                            <div class="code-tabs">
                                {{range $index, $script := .Shader.ShaderScripts}}
                                <button class="tab-btn {{if eq $index 0}}active{{end}}" data-target="editor-{{$index}}">
                                    Script {{$index}}
                                    <span class="tab-close" data-tab="{{$index}}">×</span>
                                </button>
                                {{else}}
                                <button class="tab-btn active" data-target="editor-0">
                                    Fragment Shader
                                    <span class="tab-close" data-tab="0">×</span>
                                </button>
                                {{end}}
                                <button class="tab-btn add-tab" id="add-script" title="Add new script">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="code-editor-container">
                            {{range $index, $script := .Shader.ShaderScripts}}
                            <div class="code-editor-wrapper {{if eq $index 0}}active{{end}}" id="wrapper-{{$index}}">
                                <textarea id="editor-{{$index}}" 
                                        class="shader-code" 
                                        data-script-id="{{$script.ID}}"
                                        placeholder="Enter your WGSL shader code here...">{{$script.Code}}</textarea>
                            </div>
                            {{else}}
                            <div class="code-editor-wrapper active" id="wrapper-0">
                                <textarea id="editor-0" 
                                        class="shader-code" 
                                        data-script-id="0"
                                        placeholder="Enter your WGSL shader code here...">@fragment
fn main() -> @location(0) vec4<f32> {
    return vec4<f32>(1.0, 0.0, 0.0, 1.0);
}</textarea>
                            </div>
                            {{end}}
                        </div>
                    </div>

                    <!-- Resizer handle (only visible on large screens) -->
                    <div class="resize-handle" data-resize-handle>
                        <div class="resize-line"></div>
                    </div>

                    <!-- Preview Panel -->
                    <div class="preview-panel split-window-pane right" data-pane="right">
                        <div class="panel-header">
                            <h3>Preview</h3>
                            <div class="preview-controls">
                                <button class="btn-icon" id="compile-shader" title="Compile shader">
                                    <i class="fas fa-cogs"></i>
                                </button>
                                <button class="btn-icon" id="fullscreen-preview" title="Fullscreen preview">
                                    <i class="fas fa-expand"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="preview-content">
                            <canvas id="webgpu-canvas" width="400" height="400"></canvas>
                            
                            <!-- Console/Error panel -->
                            <div class="console-panel">
                                <div class="console-header">
                                    <span class="console-title">Console</span>
                                    <button class="btn-icon" id="clear-console" title="Clear console">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                                <div id="shader-errors" class="console-content"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    // Pass shader data to JavaScript
    window.shaderData = {
        id: {{if .Shader.ID}}{{.Shader.ID}}{{else}}null{{end}},
        name: "{{if .Shader.Name}}{{.Shader.Name}}{{else}}New Shader{{end}}",
        shader_scripts: [
            {{range .Shader.ShaderScripts}}
            {
                id: {{.ID}},
                code: {{.Code | printf "%q"}},
                buffer: {
                    format: "{{if .Buffer.Format}}{{.Buffer.Format}}{{else}}rgba8unorm{{end}}",
                    width: {{if .Buffer.Width}}{{.Buffer.Width}}{{else}}512{{end}},
                    height: {{if .Buffer.Height}}{{.Buffer.Height}}{{else}}512{{end}}
                }
            },
            {{else}}
            {
                id: 0,
                code: "@fragment\nfn main(@builtin(position) fragCoord: vec4<f32>) -> @location(0) vec4<f32> {\n    let uv = fragCoord.xy / vec2<f32>(512.0, 512.0);\n    return vec4<f32>(uv, 0.5, 1.0);\n}",
                buffer: {
                    format: "rgba8unorm",
                    width: 512,
                    height: 512
                }
            }
            {{end}}
        ],
        tags: [
            {{range .Shader.Tags}}
            {
                id: {{.ID}},
                name: "{{.Name}}"
            },
            {{end}}
        ]
    };
    </script>

    <!-- WebGPU Shader System Scripts -->
    <script src="/static/js/webgpu-core.js"></script>
    <script src="/static/js/shader-compiler.js"></script>
    <script src="/static/js/buffer-manager.js"></script>
    <script src="/static/js/script-engine.js"></script>
    <script src="/static/js/visualization-engine.js"></script>
    <script src="/static/js/shader-workspace.js"></script>
    <script src="/static/js/shader-crud.js"></script>
    <script src="/static/js/shader-crud-tests.js"></script>
    <script src="/static/js/split_window.js"></script>
    
    <!-- Editor Integration Script -->
    <script>
    document.addEventListener('DOMContentLoaded', async function() {
        const editorContainer = document.querySelector('.editor-page');
        let workspace = null;
        let activeScriptId = 0;
        let initializationInProgress = false;

        // Console helper
        function showConsoleMessage(message, type = 'info') {
            const console = document.querySelector('#shader-errors');
            if (console) {
                const messageElement = document.createElement('div');
                messageElement.className = `console-message ${type}`;
                messageElement.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                console.appendChild(messageElement);
                console.scrollTop = console.scrollHeight;
                
                // Limit console messages to prevent memory issues
                while (console.children.length > 100) {
                    console.removeChild(console.firstChild);
                }
            }
        }

        // Initialize workspace with timeout protection
        async function initializeWorkspace() {
            if (initializationInProgress) return;
            initializationInProgress = true;
            
            try {
                showConsoleMessage('Initializing WebGPU workspace...', 'info');
                
                workspace = new ShaderWorkspace(editorContainer, {
                    autoSave: false,
                    realTimeExecution: false
                });

                console.log('Created workspace, starting initialization...');
                await workspace.initialize();
                console.log('Workspace initialization complete');
                
                // Check if we have existing shader data or should create new
                if (window.shaderData && window.shaderData.id) {
                    console.log('Loading existing shader:', window.shaderData);
                    showConsoleMessage(`Loading shader: ${window.shaderData.name}`, 'info');
                    await workspace.loadShader(window.shaderData);
                    activeScriptId = window.shaderData.shader_scripts.length > 0 ? window.shaderData.shader_scripts[0].id : 0;
                } else {
                    console.log('Creating new shader...');
                    showConsoleMessage('Creating new shader...', 'info');
                    await workspace.createNewShader(window.shaderData?.name || 'New Shader');
                    activeScriptId = 0;
                }
                
                // Update the textarea data-script-id to match the actual script ID
                const defaultTextarea = document.querySelector('#editor-0');
                if (defaultTextarea) {
                    defaultTextarea.dataset.scriptId = activeScriptId.toString();
                    console.log('Updated textarea script ID to', activeScriptId);
                }
                
                showConsoleMessage('Workspace ready', 'success');
                console.log('Shader workspace ready');

            } catch (error) {
                console.error('Failed to initialize workspace:', error);
                showConsoleMessage('WebGPU initialization failed: ' + error.message, 'error');
                
                // Fallback: disable WebGPU features
                const canvas = document.querySelector('#webgpu-canvas');
                if (canvas) {
                    const ctx = canvas.getContext('2d');
                    if (ctx) {
                        ctx.fillStyle = '#333';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        ctx.fillStyle = '#fff';
                        ctx.font = '16px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText('WebGPU not available', canvas.width/2, canvas.height/2);
                    }
                }
            } finally {
                initializationInProgress = false;
            }
        }

        // Editor event handlers with debouncing
        function setupEditorEventHandlers() {
            // Save button
            const saveBtn = document.querySelector('#save-shader');
            const createBtn = document.querySelector('#create-shader');
            
            if (saveBtn) {
                saveBtn.addEventListener('click', async () => {
                    if (!workspace) return;
                    
                    try {
                        saveBtn.disabled = true;
                        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                        
                        await workspace.saveShader();
                        showConsoleMessage('Shader saved successfully', 'success');
                        
                    } catch (error) {
                        showConsoleMessage('Save failed: ' + error.message, 'error');
                    } finally {
                        saveBtn.disabled = false;
                        saveBtn.innerHTML = '<i class="fas fa-save"></i> Save';
                    }
                });
            }

            if (createBtn) {
                createBtn.addEventListener('click', async () => {
                    if (!workspace) return;
                    
                    try {
                        createBtn.disabled = true;
                        createBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
                        
                        await workspace.saveShader();
                        showConsoleMessage('Shader created successfully', 'success');
                        
                        // Redirect to edit page with new ID
                        if (workspace.currentShader?.id) {
                            window.location.href = `/editor/${workspace.currentShader.id}`;
                        }
                        
                    } catch (error) {
                        showConsoleMessage('Create failed: ' + error.message, 'error');
                    } finally {
                        createBtn.disabled = false;
                        createBtn.innerHTML = '<i class="fas fa-plus"></i> Create Shader';
                    }
                });
            }

            // Run button
            const runBtn = document.querySelector('#run-shader');
            if (runBtn) {
                runBtn.addEventListener('click', async () => {
                    if (!workspace) return;
                    
                    try {
                        runBtn.disabled = true;
                        runBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Running...';
                        
                        // Update script code from active editor before running
                        const activeEditor = document.querySelector('.code-editor-wrapper.active textarea');
                        if (activeEditor) {
                            const scriptId = parseInt(activeEditor.dataset.scriptId) || 0;
                            const currentCode = activeEditor.value;
                            console.log('Updating script', scriptId, 'with code from editor:', currentCode);
                            workspace.updateScriptCode(scriptId, currentCode);
                        }
                        
                        await workspace.runAllScripts();
                        showConsoleMessage('Shader executed successfully', 'success');
                        
                    } catch (error) {
                        showConsoleMessage('Execution failed: ' + error.message, 'error');
                    } finally {
                        runBtn.disabled = false;
                        runBtn.innerHTML = '<i class="fas fa-play"></i> Run';
                    }
                });
            }

            // Compile button
            const compileBtn = document.querySelector('#compile-shader');
            if (compileBtn) {
                compileBtn.addEventListener('click', async () => {
                    if (!workspace) return;
                    
                    try {
                        const activeTextarea = document.querySelector('.code-editor-wrapper.active textarea');
                        if (activeTextarea) {
                            const code = activeTextarea.value;
                            await workspace.shaderCompiler.compileShader(code);
                            showConsoleMessage('Shader compiled successfully', 'success');
                        }
                    } catch (error) {
                        showConsoleMessage('Compilation failed: ' + error.message, 'error');
                        if (error.details) {
                            error.details.forEach(detail => {
                                showConsoleMessage(`Line ${detail.line}: ${detail.message}`, 'error');
                            });
                        }
                    }
                });
            }

            // Clear console button
            const clearConsoleBtn = document.querySelector('#clear-console');
            if (clearConsoleBtn) {
                clearConsoleBtn.addEventListener('click', () => {
                    const console = document.querySelector('#shader-errors');
                    if (console) {
                        console.innerHTML = '';
                    }
                });
            }

            // Code editor changes
            const codeEditors = document.querySelectorAll('.shader-code');
            codeEditors.forEach((editor, index) => {
                let debounceTimer;
                
                editor.addEventListener('input', () => {
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(() => {
                        if (workspace && editor.dataset.scriptId) {
                            const scriptId = parseInt(editor.dataset.scriptId) || index;
                            workspace.updateScriptCode(scriptId, editor.value);
                        }
                    }, 500); // Debounce for 500ms
                });
            });

            // Tab switching
            const tabButtons = document.querySelectorAll('.tab-btn:not(.add-tab)');
            tabButtons.forEach(tab => {
                tab.addEventListener('click', () => {
                    const targetId = tab.dataset.target;
                    
                    // Update active tab
                    document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // Update active editor
                    document.querySelectorAll('.code-editor-wrapper').forEach(w => w.classList.remove('active'));
                    const targetWrapper = document.querySelector(`#wrapper-${targetId.split('-')[1]}`);
                    if (targetWrapper) {
                        targetWrapper.classList.add('active');
                        activeScriptId = parseInt(targetId.split('-')[1]) || 0;
                    }
                });
            });

            // Add script button
            const addScriptBtn = document.querySelector('#add-script');
            if (addScriptBtn) {
                addScriptBtn.addEventListener('click', async () => {
                    if (!workspace) return;
                    
                    try {
                        const newScriptId = await workspace.addScript();
                        
                        // Get the actual script data from workspace
                        const newScript = workspace.getScript(newScriptId);
                        const scriptCode = newScript ? newScript.code : workspace.getDefaultShaderCode('fragment');
                        
                        // Add new tab and editor
                        const tabContainer = document.querySelector('.code-tabs');
                        const editorContainer = document.querySelector('.code-editor-container');
                        
                        if (tabContainer && editorContainer) {
                            // Create new tab
                            const newTab = document.createElement('button');
                            newTab.className = 'tab-btn';
                            newTab.dataset.target = `editor-${newScriptId}`;
                            newTab.innerHTML = `Script ${newScriptId} <span class="tab-close" data-tab="${newScriptId}">×</span>`;
                            
                            // Insert before add button
                            tabContainer.insertBefore(newTab, addScriptBtn);
                            
                            // Create new editor with the actual script code
                            const newEditor = document.createElement('div');
                            newEditor.className = 'code-editor-wrapper';
                            newEditor.id = `wrapper-${newScriptId}`;
                            newEditor.innerHTML = `
                                <textarea id="editor-${newScriptId}" 
                                        class="shader-code" 
                                        data-script-id="${newScriptId}"
                                        placeholder="Enter your WGSL shader code here...">${scriptCode}</textarea>
                            `;
                            
                            editorContainer.appendChild(newEditor);
                            
                            // Set up event listener for the new editor
                            const newTextarea = newEditor.querySelector('textarea');
                            let debounceTimer;
                            newTextarea.addEventListener('input', () => {
                                clearTimeout(debounceTimer);
                                debounceTimer = setTimeout(() => {
                                    if (workspace) {
                                        workspace.updateScriptCode(newScriptId, newTextarea.value);
                                    }
                                }, 500);
                            });
                            
                            // Switch to new tab
                            newTab.click();
                        }
                        
                        showConsoleMessage(`Added new script ${newScriptId}`, 'info');
                        
                    } catch (error) {
                        showConsoleMessage('Failed to add script: ' + error.message, 'error');
                    }
                });
            }
        }

        // Initialize event handlers
        setupEditorEventHandlers();

        // Initialize workspace
        console.log('Starting workspace initialization...');
        
        // Test basic functionality first
        setTimeout(() => {
            console.log('Basic setTimeout working');
            showConsoleMessage('JavaScript execution test passed', 'info');
        }, 100);
        
        // Initialize workspace with delay to ensure DOM is ready
        setTimeout(() => {
            initializeWorkspace();
        }, 500);

        // Make workspace globally available for debugging
        window.shaderWorkspace = workspace;
    });
    </script>
{{ end }}